#!/bin/env python2
import io
import feedparser
import ConfigParser

import mysql.connector
from decimal import Decimal
from datetime import datetime, date, timedelta

settings = {}

def read_settings():
    path = '/root/config.ini'
    with open(path) as file:
        fdata = file.read()
    
    config = ConfigParser.RawConfigParser(allow_no_value=True)
    config.readfp(io.BytesIO(fdata))
    print("File: %s" % path)
    for sect in config.sections():
        print(": %s" % sect)
        settings[sect] = {}
        for opt in config.options(sect):
            val = config.get(sect, opt)
            settings[sect][opt] = val	
            print("  - %s = %s" % (opt, val))
    return settings

def dbconnect():
    sqlsett = settings['mysql']
    socket = sqlsett['socket']
    user = sqlsett['user']
    passwd = sqlsett['password']
    db  = 'cves_dev'
    sqlcon = mysql.connector.connect(unix_socket=socket, user=user, password=passwd, database=db)
    return sqlcon

def query_usn_cve(cve):
    print("Query: %s" % cve)
    url = 'https://usn.ubuntu.com/usn/rss.xml'
    print("Parsing USN Feed: %s" % url)
    d = feedparser.parse(url)
    for e in d.entries:
        if e.summary.find(cve) > -1:
           print("Found It!")
           return e
    print('%s not found' % cve)
    return False

def format_usn(usn):
    pdate = usn.published_parsed
    p = "%s-%s-%s" % (pdate[0], pdate[1], pdate[2]) # tm_year, tm_mon, tm_mday == YYYY-M-D
    t = usn.title
    u = t[:t.find(":")]
    notice = {
        "id":0,
        "usnid":u,
        "title":t,
        "link":usn.link,
        "published":p,
        "summary":usn.summary,
        "cves":CVES
    }
    return notice

SETTINGS = read_settings()
print("\nSETTINGS:")
print(SETTINGS)
print("")

CVES = ('CVE-2017-0861') # Chosen for first page RSS presence
usn = query_usn_cve(CVES[0])
print(usn.link)
print("")

notice = format_usn(usn)
cvedb = dbconnect()
print(cvedb)
print("")

cursor = cvedb.cursor()
cursor.execute('CREATE TABLE IF NOT EXISTS usn (id INT NOT NULL AUTO_INCREMENT, usnid VARCHAR(16), title TINYTEXT, link VARCHAR(32), published DATE, summary LONGTEXT, cves TEXT, PRIMARY KEY (id))')

cvedb.commit()

cursor.execute('INSERT INTO usn VALUES("%s", "%s", "%s", "%s", "%s", \'%s\', "%s")' % (notice['id'], notice['usnid'], notice['title'], notice['link'], notice['published'], notice['summary'], notice['cves']))

cvedb.commit()

cursor.execute('SELECT * FROM usn')
for x in cursor.fetchall():
    print(x)
