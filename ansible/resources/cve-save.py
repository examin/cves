#!/bin/env python2
import io
import feedparser
import ConfigParser

import mysql.connector
from decimal import Decimal
from datetime import datetime, date, timedelta

settings = {}

def read_settings():
    path = '/root/config.ini'
    with open(path) as file:
        fdata = file.read()
    
    config = ConfigParser.RawConfigParser(allow_no_value=True)
    config.readfp(io.BytesIO(fdata))
    print("File: %s" % path)
    for sect in config.sections():
        print(": %s" % sect)
        settings[sect] = {}
        for opt in config.options(sect):
            val = config.get(sect, opt)
            settings[sect][opt] = val	
            print("  - %s = %s" % (opt, val))
    return settings

def dbconnect():
    sqlsett = settings['mysql']
    socket = sqlsett['socket']
    user = sqlsett['user']
    passwd = sqlsett['password']
    db  = 'cves_dev'
    sqlcon = mysql.connector.connect(unix_socket=socket, user=user, password=passwd, database=db)
    return sqlcon

def query_usn_cve(cve):
    print("Query: %s" % cve)
    url = 'https://usn.ubuntu.com/usn/rss.xml'
    print("Parsing USN Feed: %s" % url)
    d = feedparser.parse(url)
    for e in d.entries:
        if e.summary.find(cve) > -1:
           print("Found It!")
           return e
    print('%s not found' % cve)
    return False

def format_usn(usn):
    notice = {
        "id":0,
        "title":usn.title,
        "link":usn.link,
        "published":usn.published_parsed,
        "summary":""
    }
    return notice

SETTINGS = read_settings()
print("\nSETTINGS:")
print(SETTINGS)
print("")

usn = query_usn_cve('CVE-2017-0861')
print(usn.link)
print("")

notice = format_usn(usn)
cvedb = dbconnect()
print(cvedb)
print("")
